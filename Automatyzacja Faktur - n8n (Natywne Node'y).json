{
  "name": "Automatyzacja Faktur - n8n (Natywne Node'y)",
  "nodes": [
    {
      "parameters": {
        "downloadAttachments": true,
        "options": {}
      },
      "name": "Email Trigger - Faktury",
      "type": "n8n-nodes-base.emailReadImap",
      "typeVersion": 2,
      "position": [
        -2288,
        224
      ],
      "id": "9bda8406-d8af-4aba-b4b0-546bfd1592ae",
      "credentials": {
        "imap": {
          "id": "KVRJ4MgHrdeGdnli",
          "name": "faktury@dotykowewlaczniki.pl"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.attachments?.[0]?.contentType }}",
              "operation": "contains",
              "value2": "pdf"
            }
          ]
        },
        "options": {}
      },
      "name": "Filtr - Tylko PDF",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2064,
        224
      ],
      "id": "0ca8a30a-e0b6-4799-baa6-f0fd0603b2d7"
    },
    {
      "parameters": {},
      "name": "Opóźnienie",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -1840,
        224
      ],
      "id": "02fb9feb-cca7-4695-bfce-705092342596",
      "webhookId": "{{ $workflow.id }}"
    },
    {
      "parameters": {
        "jsCode": "// Parse odpowiedzi Anthropic\nconst response = $input.item.json;\nlet textContent = '';\n\n// Anthropic zwraca różne formaty w zależności od node'a\nif (Array.isArray(response)) {\n  // Jeśli response jest array [{ content: [...] }]\n  const firstItem = response[0];\n  if (firstItem?.content && Array.isArray(firstItem.content)) {\n    const textBlock = firstItem.content.find(c => c.type === 'text');\n    textContent = textBlock?.text || '';\n  }\n} else if (response.content && Array.isArray(response.content)) {\n  // Lub bezpośrednio { content: [...] }\n  const textBlock = response.content.find(c => c.type === 'text');\n  textContent = textBlock?.text || '';\n} else if (response.text) {\n  // Fallback na text\n  textContent = response.text;\n} else {\n  throw new Error('Nie można wyodrębnić odpowiedzi z Anthropic');\n}\n\n// Usuń markdown code blocks i escaped newlines\ntextContent = textContent\n  .replace(/```json\\n?/g, '')\n  .replace(/```\\n?/g, '')\n  .replace(/\\\\n/g, '\\n')  // Zamień \\n na prawdziwe newline\n  .trim();\n\n// Parse JSON\ntry {\n  const invoiceData = JSON.parse(textContent);\n  return { json: invoiceData };\n} catch (error) {\n  // Spróbuj wyciągnąć JSON z tekstu\n  const jsonMatch = textContent.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    return { json: JSON.parse(jsonMatch[0]) };\n  }\n  throw new Error('Nie można sparsować JSON: ' + error.message + '\\nText: ' + textContent.substring(0, 200));\n}\n"
      },
      "name": "Parse JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1408,
        224
      ],
      "id": "f9b55113-c5de-4b68-90fe-08bc556f914a",
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appbLQjOUm58ckRwu",
          "mode": "list",
          "cachedResultName": "Automatyzacja faktur - Gotowy Scenariusz",
          "cachedResultUrl": "https://airtable.com/appbLQjOUm58ckRwu"
        },
        "table": "tbl2jnB2TinJgSh6b",
        "filterByFormula": "==AND({Numer FV} = '{{ $json.invoice_number }}', {Dostawca} = '{{ $json.supplier }}')\n",
        "options": {}
      },
      "name": "Airtable - Sprawdź duplikaty",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        -1136,
        224
      ],
      "id": "80e0243b-ce8f-43a6-ac10-7ddc08be5082",
      "credentials": {
        "airtableTokenApi": {
          "id": "cESNwbJE8vayxBAP",
          "name": "Airtable_new"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst isDuplicate = items.length > 0;\nreturn { json: { isDuplicate, count: items.length } };"
      },
      "name": "Sprawdź duplikat",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        224
      ],
      "id": "85d68929-7679-4931-b591-20b2b868324e"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.isDuplicate }}",
              "value2": false
            }
          ]
        },
        "options": {}
      },
      "name": "Router",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -720,
        224
      ],
      "id": "3d08d162-fbe1-4008-a041-61e75ff3649f"
    },
    {
      "parameters": {
        "name": "={{ $('Parse JSON').item.json.invoice_number }}_{{ $('Parse JSON').item.json.supplier }}.pdf",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "=1oVJ1_nUgEoGji6bjXg7L8Yv_nh9q0ZZu",
          "mode": "id"
        },
        "options": {}
      },
      "name": "GDrive - Upload",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        288,
        144
      ],
      "id": "7c4636ed-3545-449c-b545-97de94739cfd",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "SkSqmGL1MCRJAUE8",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "preBuiltAgentsCalloutGoogleDrive": "",
        "authentication": "oAuth2",
        "resource": "file",
        "operation": "share",
        "fileId": "={{ $json.id }}",
        "permissionsUi": {},
        "options": {}
      },
      "name": "GDrive - Udostępnij",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        512,
        144
      ],
      "id": "8af4095f-4183-4391-bbe2-b01ac8681352",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "SkSqmGL1MCRJAUE8",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "base": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "table": "tbl2jnB2TinJgSh6b"
      },
      "name": "Airtable - Zapisz",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        720,
        144
      ],
      "id": "1da8cae0-da44-4572-841d-9b652a4bfeca",
      "credentials": {
        "airtableTokenApi": {
          "id": "d0RVDa54wZa7i7KV",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "faktury",
          "mode": "name"
        },
        "text": "=:white_check_mark: *Nowa faktura*\n\n*Nr:* {{ $('Merge').item.json.invoice_number }}\n*Dostawca:* {{ $('Merge').item.json.supplier }}\n*Kwota:* {{ $('Merge').item.json.gross_amount }} PLN\n*Data:* {{ $('Merge').item.json.issue_date }}\n\n<{{ $('GDrive - Udostępnij').item.json.webViewLink }}|Zobacz>",
        "otherOptions": {}
      },
      "name": "Slack - Nowa",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        944,
        144
      ],
      "id": "a03cb429-92e3-446d-9a5e-15cc47b38d2c",
      "webhookId": "8771a9dd-59ce-4ecb-bd75-52ad3a56b512"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "faktury",
          "mode": "name"
        },
        "text": "=:warning: *Duplikat*\n\n*Nr:* {{ $('Merge').item.json.invoice_number }}\n*Dostawca:* {{ $('Merge').item.json.supplier }}\n\nFaktura już istnieje w systemie.",
        "otherOptions": {}
      },
      "name": "Slack - Duplikat",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        -496,
        368
      ],
      "id": "69f34e1f-bd8d-40c1-be9d-c20b55a26e96",
      "webhookId": "04be587d-418e-4b18-a75b-ca3804cd9345",
      "credentials": {
        "slackOAuth2Api": {
          "id": "2leTHPN55jPNsfHP",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "claude-3-7-sonnet-20250219"
        },
        "text": "Instrukcja ekstrakcji danych z faktur\nNa podstawie dostarczonego tekstu faktury, znajdź i wyodrębnij następujące informacje. Zwróć TYLKO obiekt JSON, bez żadnych dodatkowych komentarzy, oznaczeń formatowania czy znaczników kodu.\n\nNajpierw sprawdź czy to jest faktura szukając wskaźników:\n\nA. Bezpośrednie wskazania faktury:\n- Słowa kluczowe: \"faktura\", \"FV\", \"VAT\", \"rachunek\", \"należność\", \"dokument księgowy\", \"invoice\", \"invoiced\", \"billing\"\n- Numery faktur (np. FV/2024/123, VAT/2024/01)\n- Frazy \"w załączeniu faktura\", \"przesyłam fakturę\", \"załączam FV\"\n\nB. Pośrednie wskazania faktury:\n- Kwoty z określeniem \"netto\" lub \"brutto\"\n- Kwoty poprzedzone znakiem waluty ($, €, £)\n- Terminy płatności (np. \"termin płatności\", \"płatne do\")\n- Numery kont bankowych\n- Dane do przelewu\n- \"Do zapłaty\"\n- \"Proszę o zapłatę\"\n- \"Proforma\"\n- \"Nota księgowa\"\n- \"Rozliczenie\"\n- Frazy potwierdzające wystawienie dokumentu księgowego:\n * \"invoiced amount\"\n * \"payment received\"\n * \"payment confirmation\"\n- Daty transakcji/płatności w kontekście kwot\n- Informacje o metodzie płatności (np. \"payment method\", \"card ending with\")\n\nJeśli to nie jest faktura (brak powyższych wskaźników), zwróć obiekt JSON z wartością \"NOT_INVOICE\" w polu invoice_number i null w pozostałych polach.\n\nJeśli to jest faktura, wyodrębnij następujące informacje:\n\nNumer faktury (invoice_number)\nSzukaj: \"FV\", \"Faktura VAT\", \"Invoice no.\", \"Invoice number\"\nFormaty: FV/2024/01/123, INV-2024-001, 2024/ABC/123\n\nDane dostawcy (supplier)\nSzukaj: \"Sprzedawca\", \"Wystawca\", \"Supplier\", \"Seller\"\nTylko nazwa firmy, bez adresu\n\nData wystawienia (issue_date)\nSzukaj: \"Data wystawienia\", \"Issue date\", \"Invoice date\"\nFormat wyjściowy: YYYY-MM-DD\n\nData sprzedaży (sale date)\nSzukaj: \"Data sprzedaży\"\nFormat wyjściowy: YYYY-MM-DD\n\nNIP sprzedawcy (seller's ID)\nSzukaj w danych adresowych sprzedawcy \"NIP\"\nFormat wyjściowy: dziesięcio liczbowy kod + może być poprzedzony przedrostkiem Kraju np. PL lub z myślnikami\n\n\nKwota netto (net_amount)\nSzukaj: \"Wartość netto\", \"Net amount\", \"Subtotal\"\nLiczba z kropką, 2 miejsca po przecinku\nBez waluty\n\nKwota brutto (gross_amount)\nSzukaj: \"Wartość brutto\", \"Gross amount\", \"Total\", \"Do zapłaty\", \"Total due\"\nLiczba z kropką, 2 miejsca po przecinku\nBez waluty\n\n\nKwota VAT (vat amount)\nSzukaj: \"Wartość VAT\",\"Kwota VAT\" \"vat amount\", \"Total \",\nLiczba z kropką, 2 miejsca po przecinku\nBez waluty\n\nZasady przetwarzania:\n- Dla nieznalezionych danych użyj null\n- Nie zgaduj brakujących danych\n- Przy wielu wartościach wybierz najbardziej prawdopodobną\n- Ignoruj przykładowe i przekreślone dane\n\nFormat odpowiedzi:\nZWRÓĆ TYLKO PONIŻSZY OBIEKT JSON, BEZ ŻADNYCH DODATKOWYCH ZNACZNIKÓW CZY KOMENTARZY:\n{\n\"invoice_number\": \"string or NOT_INVOICE or null\",\n\"supplier\": \"string or null\",\n\"issue_date\": \"YYYY-MM-DD or null\",\n\"sale date\": \"YYYY-MM-DD or null\",\n\"seller's ID\": number or null\n\"net_amount\": number or null,\n\"gross_amount\": number or null\n\"vat amount\":number or null\n}\nNiektóre faktury będą w innej walucie niż PLN. Np. \n*CZK, EUR,USD, HUF\n\nJeśli jest taka faktura to zastosuj przelicznik na PLN (polski złoty) z ostatniego dnia kursu.",
        "inputType": "binary",
        "binaryPropertyName": "attachment_0",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        -1616,
        224
      ],
      "id": "9ce89625-79ce-4bb1-af79-5cca8a583128",
      "name": "Analyze document",
      "credentials": {
        "anthropicApi": {
          "id": "OYlRsing9b5MkBha",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "={{ $('Merge').item.json.issue_date.substring(5, 7) }}\n",
        "driveId": {
          "__rl": true,
          "value": "My Drive",
          "mode": "list",
          "cachedResultName": "My Drive",
          "cachedResultUrl": "https://drive.google.com/drive/my-drive"
        },
        "folderId": {
          "__rl": true,
          "value": "=1oVJ1_nUgEoGji6bjXg7L8Yv_nh9q0ZZu",
          "mode": "id"
        },
        "options": {
          "simplifyOutput": false,
          "folderColorRgb": ""
        }
      },
      "name": "GDrive - Utwórz folder miesiąca",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -64,
        112
      ],
      "id": "c6ba7719-5866-4612-98eb-c0518bf3e133",
      "retryOnFail": false,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "SkSqmGL1MCRJAUE8",
          "name": "Google Drive account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "={{ $('Merge').item.json.issue_date.substring(0, 4) }}\n",
        "driveId": {
          "__rl": true,
          "value": "My Drive",
          "mode": "list",
          "cachedResultName": "My Drive",
          "cachedResultUrl": "https://drive.google.com/drive/my-drive"
        },
        "folderId": {
          "__rl": true,
          "mode": "id",
          "value": "=1oVJ1_nUgEoGji6bjXg7L8Yv_nh9q0ZZu"
        },
        "options": {
          "simplifyOutput": false,
          "folderColorRgb": ""
        }
      },
      "name": "GDrive - Utwórz folder\" (na rok)",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -320,
        112
      ],
      "id": "7fbef553-e00d-4d18-bee1-1d540f5306ff",
      "retryOnFail": false,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "SkSqmGL1MCRJAUE8",
          "name": "Google Drive account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "pinData": {},
  "connections": {
    "Email Trigger - Faktury": {
      "main": [
        [
          {
            "node": "Filtr - Tylko PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtr - Tylko PDF": {
      "main": [
        [
          {
            "node": "Opóźnienie",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JSON": {
      "main": [
        [
          {
            "node": "Airtable - Sprawdź duplikaty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable - Sprawdź duplikaty": {
      "main": [
        [
          {
            "node": "Sprawdź duplikat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sprawdź duplikat": {
      "main": [
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router": {
      "main": [
        [
          {
            "node": "GDrive - Utwórz folder\" (na rok)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Slack - Duplikat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GDrive - Upload": {
      "main": [
        [
          {
            "node": "GDrive - Udostępnij",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GDrive - Udostępnij": {
      "main": [
        [
          {
            "node": "Airtable - Zapisz",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable - Zapisz": {
      "main": [
        [
          {
            "node": "Slack - Nowa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Opóźnienie": {
      "main": [
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "Parse JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GDrive - Utwórz folder miesiąca": {
      "main": [
        [
          {
            "node": "GDrive - Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GDrive - Utwórz folder\" (na rok)": {
      "main": [
        [
          {
            "node": "GDrive - Utwórz folder miesiąca",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3595bcf8-5fe2-4bc0-9a60-9ba21891820d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "39bca4b1b4afbda9bdcd92db7d64c146e05fb358d1b97706f31d9d17518af792"
  },
  "id": "ZpG1GvXFesi9MPqR",
  "tags": [
    {
      "name": "faktury",
      "id": "qZ1h9f6m16FKb8II",
      "updatedAt": "2025-12-15T17:26:48.658Z",
      "createdAt": "2025-12-15T17:26:48.658Z"
    }
  ]
}